---
layout: post
title: "URL缓存"
tags: [iOS]
categories: [Tech]
cover: "upload/blog_masonry_05.jpg"
---

<br>

初始化并设置一个共享（全局）的URL缓存，在-application:didFinishLaunchingWithOptions:中完成设置

<br>

{% highlight objc %}
- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions
 {
   NSURLCache *URLCache = [[NSURLCache alloc]initWithMemoryCapacity:5 * 1024 *1024 diskCapacity:30 * 1024 *1024 diskPath:nil];
   [NSURLCache setSharedURLCache:URLCache];
   return YES;
 }
{% endhighlight %}


<br>

使用Etag演示url缓存

<br>

{% highlight objc %}
NSURL *url = [NSURL URLWithString:@"http://www.baidu.com"];
NSMutableURLRequest *mutableRequest = [NSMutableURLRequest requestWithURL:url cachePolicy:(NSURLRequestReloadIgnoringCacheData) timeoutInterval:15.0];   
//发送etag
NSString *etag = [[NSUserDefaults standardUserDefaults]objectForKey:@"url对应的key值"];
if (etag.length > 0) {
     [mutableRequest setValue:etag forHTTPHeaderField:@"If-None-Match"];
}

[[NSURLSession sharedSession]dataTaskWithRequest:mutableRequest completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {
    NSHTTPURLResponse *httpResponse = (NSHTTPURLResponse *)response;
    NSLog(@"statusCode == %ld", httpResponse.statusCode);
    if (httpResponse.statusCode == 304) {// 如果是304，使用本地缓存
        // 根据请求获取到`被缓存的响应`！
        NSCachedURLResponse *cacheResponse =  [[NSURLCache sharedURLCache] cachedResponseForRequest:mutableRequest];
        // 拿到缓存的数据,然后进行页面显示
        id data = cacheResponse.data;


    }else{//假设请求成功(200)
        //获取并存储etag
        NSString *etag = httpResponse.allHeaderFields[@"Etag"];
        [[NSUserDefaults standardUserDefaults]setObject:etag forKey:@"url对应的key值"];
        //显示数据
    }
}];
{% endhighlight %}

<br>

定期处理缓存

<br>

{% highlight objc %}
 // 定期处理缓存
 if (缓存有效或者没到指定日期) {
   request.cachePolicy = NSURLRequestReturnCacheDataElseLoad;
  }
 // 获得全局的缓存对象
NSURLCache *cache = [NSURLCache sharedURLCache];
if (缓存无效或者超时) { 
   //删除此request对应的缓存文件
   [cache removeCachedResponseForRequest:request];
  }
 NSCachedURLResponse *response = [cache cachedResponseForRequest:request];
 if (response) {
 NSLog(@"---这个请求已经存在缓存");
 } else {
 NSLog(@"---这个请求没有缓存");
 }
{% endhighlight %}

[[Ref.] 来聊聊ios下的url缓存问题](https://www.jianshu.com/p/ebcb0a1823be)