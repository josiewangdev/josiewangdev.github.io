---
layout: post
title: GCD 定时器 · GCD Timer
tags: iOS
categories: Dev
---

Create a GCD timer needs following steps.

1\. Decide what kind of queue to execute the GCD timer's callback.

2\. Create a timer.

3\. Set up timer's start time, repeat time interval and the leeway for accurateness.

4\. Set up timer callback. 

5\. Start the timer (the default status of the timer is stoped).

创建一个GCD的定时器需要经过以下步骤。

1\. 创建一个队列以决定GCD定时器将来回调的方法在哪种队列里执行。

2\. 创建一个定时器资源。

3\. 设置定时器开始时间，开始后的间隔时间（单位纳秒 NSEC_PER_SEC），以及间隔精准度，代表多少秒的范围是可以接受的。

4\. 设置定时器任务回调。

5\. 开始定时器任务（定时器默认开始是暂停的，需要复位开启）。

---

{% highlight c# %}
//1
dispatch_queue_t queue = dispatch_get_global_queue(0, 0); 
//2
dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue); 
//3
dispatch_source_set_timer(timer, DISPATCH_TIME_NOW, <#intervalInSeconds#> * NSEC_PER_SEC, <#leewayInSeconds#> * NSEC_PER_SEC);
//4
dispatch_source_set_event_handler(timer, ^{
    <#code to be executed when timer fires#>
});
//5
dispatch_resume(timer);
{% endhighlight %}

---

**Example Code**

Using GCD timer to implement the count down captcha button.

**代码示例**

用GCD定时器实现验证码倒计时按钮。

---

{% highlight c# %}
__block NSInteger time = 59; //count down time

dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);

dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);

dispatch_source_set_timer(timer,DISPATCH_TIME_NOW,1.0*NSEC_PER_SEC, 0);

dispatch_source_set_event_handler(timer, ^{
    if(time <= 0){
        dispatch_source_cancel(timer);
        dispatch_async(dispatch_get_main_queue(), ^{            
            [self.captchaButton setTitle:@"send again" forState:UIControlStateNormal];
            self.timeLabel.text = @"start";
            self.captchaButton.userInteractionEnabled = YES;
        });
    }else{
        int seconds = time % 60;
        dispatch_async(dispatch_get_main_queue(), ^{  
            self.timeLabel.text = [NSString stringWithFormat:@"send again (%.2d)s",seconds];
            [self.captchaButton setTitle:@"sent" forState:UIControlStateNormal];
            self.captchaButton.userInteractionEnabled = NO;
        });
        time--;
    }
}); 

dispatch_resume(timer);

{% endhighlight %}