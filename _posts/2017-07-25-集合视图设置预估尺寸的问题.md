---
layout: post
title: 集合视图设置预估尺寸的问题 · The issue when set the estimated item size in collection view
tags: Todo
categories: Dev
---

**Problem Description:** 

Usually when we implement a view like this, we need to use `UICollectionView`, and all the items in collection view should be left-aligned.

You want to use the dynamic width and height of items and align them automatically, so you set the `estimatedItemSize` of the items in collection view. But after that, you will find the crash happens in the customized layout class `UICollectionViewLeftAlignedLayout`.

**PS:**

Crash only happens when the system is lower than `iOS 10.0`.

**问题描述:**

通常在写这样的一个页面中，会需要使用到 `UICollectionView` 并且需要其中的 items 都要左对齐。

因为想要使其使用动态高度和宽度自动布局，将 collection view 里的 item 设置 `estimatedItemSize` 后，则会在自定义左对齐布局类 `UICollectionViewLeftAlignedLayout` 中，发生崩溃。

**备注：**

崩溃只有当系统版本低于 `iOS 10.0` 的时候才会发生。

---

![collectionview](/images/collectionview_flowlayout/shopping_subtypes.jpg)

{% highlight swift %}
// LeftAlignedLayout.class
// LeftAlignedLayout inherits from UICollectionViewFlowLayout
override func layoutAttributesForElements(in rect: CGRect) -> [UICollectionViewLayoutAttributes]? {
    var attrsCopy = [UICollectionViewLayoutAttributes]()
    //crash here
    if let attrs = super.layoutAttributesForElements(in: rect) { 
        attrs.forEach({
            attrsCopy.append($0.copy() as! UICollectionViewLayoutAttributes)
        })
    }
    for attribute in attrsCopy {
        if attribute.representedElementKind == nil {
            if let attr = layoutAttributesForItem(at: attribute.indexPath) {
                attribute.frame = attr.frame
            }
        }
    }
    return attrCopy
}
{% endhighlight %}

---

**Solution:**

Use `itemSize` to set the fixed width and height for items rather than use `estimatedItemSize` to set the dynamic ones.

**解决方法:**

不再使用动态布局的 `estimatedItemSize` 而是使用固定大小 `itemSize`。

---

{% highlight swift %}
let operatingSystemVersion = OperatingSystemVersion(majorVersion: 10, minorVersion: 0, patchVersion: 0)
if ProcessInfo().isOperatingSystemAtLeast(operatingSystemVersion) {
    flowLayout.estimatedItemSize = CGSize(width: 100, height: 20)
}else {
    //system version is lower than 10.0.0
    flowLayout.itemSize = CGSize(width: 100, height: 20)
}
{% endhighlight %}

* [[Ref.参考] UICollectionView section header crashing iOS 8](https://stackoverflow.com/questions/26407149/uicollectionview-section-header-crashing-ios-8)
* [[Ref.参考] Crash on iOS8 with auto sizing cells enabled](https://github.com/CSStickyHeaderFlowLayout/CSStickyHeaderFlowLayout/issues/48)
* [[Ref.参考] Infinite Loop of layoutAttributesForElementsInRect](https://stackoverflow.com/questions/24065014/infinite-loop-of-layoutattributesforelementsinrect)

